<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KNUST WATER MONITORING DASHBOARD</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: url('https://www.dailymailgh.com/wp-content/uploads/2019/06/Water-pouring-2018.xl_.jpg') center/cover no-repeat fixed, #121212;
            color:#080808;
        }
        .dashboard-header {
            background: linear-gradient(rgba(138, 138, 138, 0.6), rgba(0, 0, 0, 0.6)), 
                        url('https://i.ibb.co/B2T6GZyy/123.png') center/cover no-repeat;
            color: rgb(255, 255, 255);
            padding: 60px 0;
            margin-bottom: 30px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8);
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }
        .filter-card {
            height: 100%;
            box-shadow: 0 4px 6px rgba(11, 11, 11, 0.1);
        }
        .map-container {
            height: 600px;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .pump-count {
            background-color: #141515;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .details-table {
            margin-top: 20px;
        }
        .filter-label {
            font-weight: 500;
            margin-top: 10px;
        }
        .reset-btn {
            width: 100%;
        }
        .card-header {
            font-weight: bold;
        }
        .leaflet-popup-content {
            min-width: 200px;
        }
        .leaflet-control-layers {
            background: rgb(250, 249, 249);
            padding: 5px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row dashboard-header">
            <div class="col-12 text-center">
                <h1><i class="fas fa-water me-2"></i>KNUST WATER MONITORING DASHBOARD</h1>
            </div>
        </div>

        <div class="row">
            <!-- Filters Column -->
            <div class="col-lg-3 col-md-4">
                <div class="card filter-card">
                    <div class="card-header bg-dark text-white">
                        <i class="fas fa-filter me-2"></i>Filters
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="filter-label">Condition:</label>
                            <select id="condition-filter" class="form-select" multiple></select>
                        </div>
                        <div class="mb-3">
                            <label class="filter-label">Mode of Transport:</label>
                            <select id="transport-filter" class="form-select" multiple></select>
                        </div>
                        <div class="mb-3">
                            <label class="filter-label">Usage Status:</label>
                            <select id="state-filter" class="form-select" multiple></select>
                        </div>
                        <div class="mb-3">
                            <label class="filter-label">Water Source:</label>
                            <select id="source-filter" class="form-select" multiple></select>
                        </div>
                        <div class="mb-3">
                            <label class="filter-label">Location:</label>
                            <select id="location-filter" class="form-select" multiple></select>
                        </div>
                        <div class="mb-3">
                            <label class="filter-label">Storage Type:</label>
                            <select id="storage-filter" class="form-select" multiple></select>
                        </div>
                        <div class="mb-3">
                            <label class="filter-label">Minimum Volume:</label>
                            <input type="number" id="volume-filter" class="form-control" placeholder="Enter minimum volume" min="0">
                        </div>
                        <button id="reset-filters" class="btn btn-secondary reset-btn">
                            <i class="fas fa-undo me-2"></i>Reset Filters
                        </button>
                    </div>
                </div>
            </div>

            <!-- Map and Details Column -->
            <div class="col-lg-9 col-md-8">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <i class="fas fa-map-marked-alt me-2"></i>Water Source Map
                    </div>
                    <div class="card-body">
                        <div id="map" class="map-container"></div>
                        <div id="pump-count" class="pump-count text-center"></div>
                    </div>
                </div>

                <div class="card mt-4">
                    <div class="card-header bg-black text-white">
                        <i class="fas fa-info-circle me-2"></i>Pump Details
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="pump-details" class="table table-striped table-bordered details-table">
                                <thead class="table-primary">
                                    <tr>
                                        <th>Location</th>
                                        <th>Condition</th>
                                        <th>Mode</th>
                                        <th>Status</th>
                                        <th>Source</th>
                                        <th>Volume</th>
                                        <th>Storage</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        let map, pumpData = [], markers = [], baseLayers = {}, routingControl;
        let uniqueValues = {
            conditions: new Set(), transportModes: new Set(),
            states: new Set(), waterSources: new Set(),
            locations: new Set(), storageTypes: new Set()
        };

        $(document).ready(function() {
            initializeMap();
            loadGeoJSONData();
            setupEventListeners();
        });

        function initializeMap() {
            map = L.map('map').setView([6.68, -1.57], 14);
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
            baseLayers = { "Street Map": osmLayer, "Satellite Imagery": satelliteLayer };
            osmLayer.addTo(map);
            L.control.layers(baseLayers, null, {position: 'topright'}).addTo(map);
        }

        function loadGeoJSONData() {
            fetch('KNUST.json')
                .then(res => res.json())
                .then(data => { processGeoJSONData(data); populateFilterDropdowns(); updateMapAndTable(); })
                .catch(() => { loadSampleData(); });
        }

        function loadSampleData() {
            const sampleData = {
                "type": "FeatureCollection",
                "features": [
                    {
                        "type": "Feature",
                        "properties": {"Condition":"good state","Mode_of_tr":"truck","State":"in use","Type_of_so":"well","Location":"Main Campus","Storage_ty":"tank","Volume":5000},
                        "geometry": {"type": "Point","coordinates": [-1.57, 6.68]}
                    }
                ]
            };
            processGeoJSONData(sampleData);
            populateFilterDropdowns();
            updateMapAndTable();
        }

        function processGeoJSONData(geojson) {
            pumpData = geojson.features.map(f => {
                const p = f.properties || {};
                const c = f.geometry?.coordinates || [0,0];
                const cond = p.Condition?.toLowerCase() || 'unknown';
                const mot = p.Mode_of_tr?.toLowerCase() || 'unknown';
                const state = p.State?.toLowerCase() || 'unknown';
                const src = p.Type_of_so?.toLowerCase() || 'unknown';
                const loc = p.Location?.toLowerCase() || 'unknown';
                const stor = p.Storage_ty?.toLowerCase() || 'unknown';
                const vol = parseFloat(p.Volume) || 0;

                uniqueValues.conditions.add(cond);
                uniqueValues.transportModes.add(mot);
                uniqueValues.states.add(state);
                uniqueValues.waterSources.add(src);
                uniqueValues.locations.add(loc);
                uniqueValues.storageTypes.add(stor);

                return {latitude:c[1], longitude:c[0], condition:cond, modeOfTransport:mot, state:state, waterSource:src, location:loc, volume:vol, storageType:stor};
            });
        }

        function populateFilterDropdowns() {
            populateDropdown('condition-filter', Array.from(uniqueValues.conditions));
            populateDropdown('transport-filter', Array.from(uniqueValues.transportModes));
            populateDropdown('state-filter', Array.from(uniqueValues.states));
            populateDropdown('source-filter', Array.from(uniqueValues.waterSources));
            populateDropdown('location-filter', Array.from(uniqueValues.locations));
            populateDropdown('storage-filter', Array.from(uniqueValues.storageTypes));
        }

        function populateDropdown(id, values) {
            const dropdown = document.getElementById(id);
            dropdown.innerHTML = '';
            values.forEach(v => { let opt = document.createElement('option'); opt.value = v; opt.textContent = v; dropdown.appendChild(opt); });
        }

        function setupEventListeners() {
            ['condition-filter','transport-filter','state-filter','source-filter','location-filter','storage-filter']
                .forEach(id => document.getElementById(id).addEventListener('change', updateMapAndTable));
            document.getElementById('volume-filter').addEventListener('input', updateMapAndTable);
            document.getElementById('reset-filters').addEventListener('click', resetFilters);
        }

        function updateMapAndTable() {
            const data = filterPumpData();
            updateMapMarkers(data);
            updateDetailsTable(data);
            updatePumpCount(data);
        }

        function filterPumpData() {
            const cf = getSelectedValues('condition-filter'), tf = getSelectedValues('transport-filter'),
                  sf = getSelectedValues('state-filter'), srcf = getSelectedValues('source-filter'),
                  lf = getSelectedValues('location-filter'), stf = getSelectedValues('storage-filter'),
                  minV = parseFloat(document.getElementById('volume-filter').value) || 0;

            return pumpData.filter(p => 
                (cf.length===0 || cf.includes(p.condition)) &&
                (tf.length===0 || tf.includes(p.modeOfTransport)) &&
                (sf.length===0 || sf.includes(p.state)) &&
                (srcf.length===0 || srcf.includes(p.waterSource)) &&
                (lf.length===0 || lf.includes(p.location)) &&
                (stf.length===0 || stf.includes(p.storageType)) &&
                (p.volume >= minV)
            );
        }

        function getSelectedValues(id) {
            return Array.from(document.getElementById(id).selectedOptions).map(o => o.value);
        }

        function updateMapMarkers(data) {
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            data.forEach(p => {
                let color;
                if (p.state.includes('not in use')) {
                    color = 'red';
                } else if (p.condition.includes('good')) {
                    color = 'Dodgerblue';
                } else {
                    color = 'green';
                }

                const popup = `
                    <b>Location:</b> ${p.location}<br>
                    <b>Condition:</b> ${p.condition}<br>
                    <b>Status:</b> ${p.state}<br>
                    <b>Source:</b> ${p.waterSource}<br>
                    <b>Volume:</b> ${p.volume} L
                    <br><button onclick="routeToPump(${p.latitude}, ${p.longitude})" class="btn btn-sm btn-primary mt-2">Route Here</button>
                `;

                const marker = L.circleMarker([p.latitude, p.longitude], {
                    radius: 2,
                    fillColor: color,
                    color: color,
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).bindPopup(popup);

                marker.addTo(map);
                markers.push(marker);
            });
        }

        function updateDetailsTable(data) {
            const tableBody = document.querySelector('#pump-details tbody');
            tableBody.innerHTML = '';
            data.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${p.location}</td><td>${p.condition}</td><td>${p.modeOfTransport}</td><td>${p.state}</td><td>${p.waterSource}</td><td>${p.volume}</td><td>${p.storageType}</td>`;
                
                row.addEventListener('click', function() {
                    routeToPump(p.latitude, p.longitude);
                });

                tableBody.appendChild(row);
            });
        }

        function routeToPump(lat, lng) {
            if (routingControl) {
                map.removeControl(routingControl);
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;

                    routingControl = L.Routing.control({
                        waypoints: [
                            L.latLng(userLat, userLng),
                            L.latLng(lat, lng)
                        ],
                        routeWhileDragging: true
                    }).addTo(map);

                }, () => alert("Could not get your location."));
            } else {
                alert("Geolocation not supported.");
            }
        }

        function updatePumpCount(data) {
            document.getElementById('pump-count').textContent = `Showing ${data.length} of ${pumpData.length} pumps`;
        }

        function resetFilters() {
            ['condition-filter','transport-filter','state-filter','source-filter','location-filter','storage-filter']
                .forEach(id => document.getElementById(id).selectedIndex = -1);
            document.getElementById('volume-filter').value = '';
            updateMapAndTable();
        }
    </script>
</body>
</html>
